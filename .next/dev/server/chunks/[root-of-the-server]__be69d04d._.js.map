{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Hardik/Downloads/crm/lib/db.ts"],"sourcesContent":["import fs from 'fs';\r\nimport path from 'path';\r\n\r\n// Determine if we are in a production environment (like Vercel)\r\nconst IS_PRODUCTION = process.env.NODE_ENV === 'production';\r\n\r\n// In production, use /tmp which is writable. In development, use local data folder.\r\nconst DATA_DIR = IS_PRODUCTION ? '/tmp' : path.join(process.cwd(), 'data');\r\nconst DB_FILE = path.join(DATA_DIR, 'db.json');\r\n\r\n// Source file to seed from (committed data)\r\nconst SEED_FILE = path.join(process.cwd(), 'data', 'db.json');\r\n\r\nimport type { CRMRecord, UploadHistory } from './types';\r\n\r\nexport interface DBUser {\r\n    id: string;\r\n    username: string; // ID/Email\r\n    password: string;\r\n    name: string;\r\n    role: 'admin' | 'agent';\r\n    createdAt: string;\r\n}\r\n\r\nexport interface DBSession {\r\n    sessionId: string;\r\n    userId: string;\r\n    punchInTime: string;\r\n    lastActiveTime: string;\r\n    isActive: boolean;\r\n}\r\n\r\ninterface DBData {\r\n    users: DBUser[];\r\n    sessions: DBSession[];\r\n    records: CRMRecord[];\r\n    uploadHistory: UploadHistory[];\r\n}\r\n\r\nconst INITIAL_DATA: DBData = {\r\n    users: [\r\n        {\r\n            id: 'admin-1',\r\n            username: 'admin',\r\n            password: 'admin123', // Default credentials\r\n            name: 'Administrator',\r\n            role: 'admin',\r\n            createdAt: new Date().toISOString(),\r\n        },\r\n        {\r\n            id: 'agent-default',\r\n            username: 'agent',\r\n            password: 'agent', // Default agent credentials\r\n            name: 'Default Agent',\r\n            role: 'agent',\r\n            createdAt: new Date().toISOString(),\r\n        }\r\n    ],\r\n    sessions: [],\r\n    records: [],\r\n    uploadHistory: []\r\n};\r\n\r\nfunction ensureDB() {\r\n    // Ensure directory exists\r\n    if (!fs.existsSync(DATA_DIR)) {\r\n        fs.mkdirSync(DATA_DIR, { recursive: true });\r\n    }\r\n\r\n    // If DB_FILE doesn't exist in the working directory\r\n    if (!fs.existsSync(DB_FILE)) {\r\n        // Try to copy from seed file (committed data) if it exists\r\n        if (fs.existsSync(SEED_FILE)) {\r\n            try {\r\n                const seedData = fs.readFileSync(SEED_FILE, 'utf-8');\r\n                fs.writeFileSync(DB_FILE, seedData);\r\n                return;\r\n            } catch (error) {\r\n                console.error(\"Failed to copy seed file:\", error);\r\n            }\r\n        }\r\n\r\n        // Fallback to INITIAL_DATA\r\n        fs.writeFileSync(DB_FILE, JSON.stringify(INITIAL_DATA, null, 2));\r\n    }\r\n}\r\n\r\nlet cachedData: DBData | null = null;\r\n\r\nfunction readDB(): DBData {\r\n    ensureDB();\r\n    if (cachedData) return cachedData;\r\n\r\n    try {\r\n        const data = fs.readFileSync(DB_FILE, 'utf-8');\r\n        cachedData = JSON.parse(data);\r\n        return cachedData!;\r\n    } catch (error) {\r\n        cachedData = JSON.parse(JSON.stringify(INITIAL_DATA));\r\n        return cachedData!;\r\n    }\r\n}\r\n\r\nfunction writeDB(data: DBData) {\r\n    ensureDB();\r\n    cachedData = data; // Update cache\r\n    fs.writeFileSync(DB_FILE, JSON.stringify(data, null, 2));\r\n}\r\n\r\nexport const db = {\r\n    getUsers: () => readDB().users,\r\n    addUser: (user: DBUser) => {\r\n        const data = readDB();\r\n        data.users.push(user);\r\n        writeDB(data);\r\n    },\r\n    deleteUser: (userId: string) => {\r\n        const data = readDB();\r\n        data.users = data.users.filter(u => u.id !== userId);\r\n        data.sessions = data.sessions.filter(s => s.userId !== userId);\r\n        writeDB(data);\r\n    },\r\n    findUser: (username: string) => readDB().users.find(u => u.username === username),\r\n\r\n    getSessions: () => readDB().sessions,\r\n    createSession: (session: DBSession) => {\r\n        const data = readDB();\r\n        // Deactivate previous sessions for this user\r\n        data.sessions.forEach(s => {\r\n            if (s.userId === session.userId && s.isActive) {\r\n                s.isActive = false;\r\n            }\r\n        });\r\n        data.sessions.push(session);\r\n        writeDB(data);\r\n    },\r\n    updateHeartbeat: (userId: string) => {\r\n        // Only update in memory to avoid triggering reload in dev\r\n        const data = readDB();\r\n        const session = data.sessions.find(s => s.userId === userId && s.isActive);\r\n        if (session) {\r\n            session.lastActiveTime = new Date().toISOString();\r\n            // We do NOT call writeDB(data) here to prevent file watcher from triggering a reload\r\n            // cachedData is already updated since it's a reference\r\n        }\r\n    },\r\n    logoutUser: (userId: string) => {\r\n        const data = readDB();\r\n        const session = data.sessions.find(s => s.userId === userId && s.isActive);\r\n        if (session) {\r\n            session.isActive = false;\r\n            writeDB(data);\r\n        }\r\n    },\r\n\r\n    // Records management\r\n    getRecords: () => readDB().records || [],\r\n    saveRecords: (records: CRMRecord[]) => {\r\n        const data = readDB();\r\n        data.records = records;\r\n        writeDB(data);\r\n    },\r\n    addRecord: (record: CRMRecord) => {\r\n        const data = readDB();\r\n        if (!data.records) data.records = [];\r\n        data.records.push(record);\r\n        writeDB(data);\r\n    },\r\n    updateRecord: (record: CRMRecord) => {\r\n        const data = readDB();\r\n        if (!data.records) data.records = [];\r\n        data.records = data.records.map(r => r.id === record.id ? record : r);\r\n        writeDB(data);\r\n    },\r\n    deleteRecord: (id: string) => {\r\n        const data = readDB();\r\n        if (!data.records) data.records = [];\r\n        data.records = data.records.filter(r => r.id !== id);\r\n        writeDB(data);\r\n    },\r\n    deleteRecords: (ids: string[]) => {\r\n        const data = readDB();\r\n        if (!data.records) data.records = [];\r\n        data.records = data.records.filter(r => !ids.includes(r.id));\r\n        writeDB(data);\r\n    },\r\n\r\n    // Upload History\r\n    getUploadHistory: () => readDB().uploadHistory || [],\r\n    addUploadHistory: (history: UploadHistory) => {\r\n        const data = readDB();\r\n        if (!data.uploadHistory) data.uploadHistory = [];\r\n        data.uploadHistory.unshift(history);\r\n        writeDB(data);\r\n    },\r\n    // Get active sessions populated with user details\r\n    getActiveAgents: () => {\r\n        const data = readDB();\r\n        return data.users.map(user => {\r\n            const activeSession = data.sessions.find(s => s.userId === user.id && s.isActive);\r\n            return {\r\n                ...user,\r\n                // Don't return password\r\n                password: '***',\r\n                isLoggedIn: !!activeSession,\r\n                punchInTime: activeSession?.punchInTime || null,\r\n                lastActiveTime: activeSession?.lastActiveTime || null,\r\n            };\r\n        });\r\n    }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 240, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Hardik/Downloads/crm/app/api/admin/users/delete/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport { db } from '@/lib/db';\r\n\r\nexport async function POST(req: Request) {\r\n    try {\r\n        const { userId } = await req.json();\r\n        if (!userId) {\r\n            return NextResponse.json({ error: 'Missing userId' }, { status: 400 });\r\n        }\r\n\r\n        db.deleteUser(userId);\r\n        return NextResponse.json({ success: true });\r\n    } catch (error) {\r\n        return NextResponse.json({ error: 'Failed to delete user' }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,KAAK,GAAY;IACnC,IAAI;QACA,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,IAAI,IAAI;QACjC,IAAI,CAAC,QAAQ;YACT,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACxE;QAEA,iHAAE,CAAC,UAAU,CAAC;QACd,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;IAC7C,EAAE,OAAO,OAAO;QACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC/E;AACJ"}}]
}