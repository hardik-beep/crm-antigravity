{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Hardik/Downloads/crm/lib/db.ts"],"sourcesContent":["import fs from 'fs';\r\nimport path from 'path';\r\n\r\nconst DB_PATH = path.join(process.cwd(), 'data');\r\nconst DB_FILE = path.join(DB_PATH, 'db.json');\r\n\r\n// Ensure data directory exists\r\nif (!fs.existsSync(DB_PATH)) {\r\n    fs.mkdirSync(DB_PATH, { recursive: true });\r\n}\r\n\r\nimport type { CRMRecord, UploadHistory } from './types';\r\n\r\nexport interface DBUser {\r\n    id: string;\r\n    username: string; // ID/Email\r\n    password: string;\r\n    name: string;\r\n    role: 'admin' | 'agent';\r\n    createdAt: string;\r\n}\r\n\r\nexport interface DBSession {\r\n    sessionId: string;\r\n    userId: string;\r\n    punchInTime: string;\r\n    lastActiveTime: string;\r\n    isActive: boolean;\r\n}\r\n\r\ninterface DBData {\r\n    users: DBUser[];\r\n    sessions: DBSession[];\r\n    records: CRMRecord[];\r\n    uploadHistory: UploadHistory[];\r\n}\r\n\r\nconst INITIAL_DATA: DBData = {\r\n    users: [\r\n        {\r\n            id: 'admin-1',\r\n            username: 'admin',\r\n            password: 'admin123', // Default credentials\r\n            name: 'Administrator',\r\n            role: 'admin',\r\n            createdAt: new Date().toISOString(),\r\n        }\r\n    ],\r\n    sessions: [],\r\n    records: [],\r\n    uploadHistory: []\r\n};\r\n\r\nfunction readDB(): DBData {\r\n    if (!fs.existsSync(DB_FILE)) {\r\n        fs.writeFileSync(DB_FILE, JSON.stringify(INITIAL_DATA, null, 2));\r\n        return INITIAL_DATA;\r\n    }\r\n    try {\r\n        const data = fs.readFileSync(DB_FILE, 'utf-8');\r\n        return JSON.parse(data);\r\n    } catch (error) {\r\n        return INITIAL_DATA;\r\n    }\r\n}\r\n\r\nfunction writeDB(data: DBData) {\r\n    fs.writeFileSync(DB_FILE, JSON.stringify(data, null, 2));\r\n}\r\n\r\nexport const db = {\r\n    getUsers: () => readDB().users,\r\n    addUser: (user: DBUser) => {\r\n        const data = readDB();\r\n        data.users.push(user);\r\n        writeDB(data);\r\n    },\r\n    deleteUser: (userId: string) => {\r\n        const data = readDB();\r\n        data.users = data.users.filter(u => u.id !== userId);\r\n        data.sessions = data.sessions.filter(s => s.userId !== userId);\r\n        writeDB(data);\r\n    },\r\n    findUser: (username: string) => readDB().users.find(u => u.username === username),\r\n\r\n    getSessions: () => readDB().sessions,\r\n    createSession: (session: DBSession) => {\r\n        const data = readDB();\r\n        // Deactivate previous sessions for this user\r\n        data.sessions.forEach(s => {\r\n            if (s.userId === session.userId && s.isActive) {\r\n                s.isActive = false;\r\n            }\r\n        });\r\n        data.sessions.push(session);\r\n        writeDB(data);\r\n    },\r\n    updateHeartbeat: (userId: string) => {\r\n        const data = readDB();\r\n        const session = data.sessions.find(s => s.userId === userId && s.isActive);\r\n        if (session) {\r\n            session.lastActiveTime = new Date().toISOString();\r\n            writeDB(data);\r\n        }\r\n    },\r\n    logoutUser: (userId: string) => {\r\n        const data = readDB();\r\n        const session = data.sessions.find(s => s.userId === userId && s.isActive);\r\n        if (session) {\r\n            session.isActive = false;\r\n            writeDB(data);\r\n        }\r\n    },\r\n\r\n    // Records management\r\n    getRecords: () => readDB().records || [],\r\n    saveRecords: (records: CRMRecord[]) => {\r\n        const data = readDB();\r\n        data.records = records;\r\n        writeDB(data);\r\n    },\r\n    addRecord: (record: CRMRecord) => {\r\n        const data = readDB();\r\n        if (!data.records) data.records = [];\r\n        data.records.push(record);\r\n        writeDB(data);\r\n    },\r\n    updateRecord: (record: CRMRecord) => {\r\n        const data = readDB();\r\n        if (!data.records) data.records = [];\r\n        data.records = data.records.map(r => r.id === record.id ? record : r);\r\n        writeDB(data);\r\n    },\r\n    deleteRecord: (id: string) => {\r\n        const data = readDB();\r\n        if (!data.records) data.records = [];\r\n        data.records = data.records.filter(r => r.id !== id);\r\n        writeDB(data);\r\n    },\r\n    deleteRecords: (ids: string[]) => {\r\n        const data = readDB();\r\n        if (!data.records) data.records = [];\r\n        data.records = data.records.filter(r => !ids.includes(r.id));\r\n        writeDB(data);\r\n    },\r\n\r\n    // Upload History\r\n    getUploadHistory: () => readDB().uploadHistory || [],\r\n    addUploadHistory: (history: UploadHistory) => {\r\n        const data = readDB();\r\n        if (!data.uploadHistory) data.uploadHistory = [];\r\n        data.uploadHistory.unshift(history);\r\n        writeDB(data);\r\n    },\r\n    // Get active sessions populated with user details\r\n    getActiveAgents: () => {\r\n        const data = readDB();\r\n        return data.users.map(user => {\r\n            const activeSession = data.sessions.find(s => s.userId === user.id && s.isActive);\r\n            return {\r\n                ...user,\r\n                // Don't return password\r\n                password: '***',\r\n                isLoggedIn: !!activeSession,\r\n                punchInTime: activeSession?.punchInTime || null,\r\n                lastActiveTime: activeSession?.lastActiveTime || null,\r\n            };\r\n        });\r\n    }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 205, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Hardik/Downloads/crm/app/api/upload-history/route.ts"],"sourcesContent":["\r\nimport { NextResponse } from 'next/server';\r\nimport { db } from '@/lib/db';\r\n\r\nexport async function GET() {\r\n    try {\r\n        const history = db.getUploadHistory();\r\n        return NextResponse.json({ history });\r\n    } catch (error) {\r\n        return NextResponse.json({ error: 'Failed to fetch history' }, { status: 500 });\r\n    }\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n    try {\r\n        const entry = await req.json();\r\n        db.addUploadHistory(entry);\r\n        return NextResponse.json({ success: true });\r\n    } catch (error) {\r\n        return NextResponse.json({ error: 'Failed to save history' }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;AACA;AACA;;;AAEO,eAAe;IAClB,IAAI;QACA,MAAM,UAAU,iHAAE,CAAC,gBAAgB;QACnC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE;QAAQ;IACvC,EAAE,OAAO,OAAO;QACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA0B,GAAG;YAAE,QAAQ;QAAI;IACjF;AACJ;AAEO,eAAe,KAAK,GAAY;IACnC,IAAI;QACA,MAAM,QAAQ,MAAM,IAAI,IAAI;QAC5B,iHAAE,CAAC,gBAAgB,CAAC;QACpB,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;IAC7C,EAAE,OAAO,OAAO;QACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAyB,GAAG;YAAE,QAAQ;QAAI;IAChF;AACJ"}}]
}