{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Hardik/Downloads/crm/lib/db.ts"],"sourcesContent":["import fs from 'fs';\r\nimport path from 'path';\r\n\r\n// Determine if we are in a Vercel environment\r\nconst IS_VERCEL = !!process.env.VERCEL;\r\n\r\n// In Vercel, we MUST use /tmp (ephemeral). \r\n// In other production environments (VPS, etc.), we prefer the persistent 'data' directory.\r\nconst DATA_DIR = IS_VERCEL ? '/tmp' : path.join(process.cwd(), 'data');\r\nconst DB_FILE = path.join(DATA_DIR, 'db.json');\r\n\r\nconsole.log(`[DB] Using storage path: ${DB_FILE} (Environment: ${IS_VERCEL ? 'Vercel' : 'Standard'})`);\r\n\r\n// Source file to seed from (committed data)\r\nconst SEED_FILE = path.join(process.cwd(), 'data', 'db.json');\r\n\r\nimport type { CRMRecord, UploadHistory } from './types';\r\n\r\nexport interface DBUser {\r\n    id: string;\r\n    username: string; // ID/Email\r\n    password: string;\r\n    name: string;\r\n    role: 'admin' | 'agent';\r\n    createdAt: string;\r\n}\r\n\r\nexport interface DBSession {\r\n    sessionId: string;\r\n    userId: string;\r\n    punchInTime: string;\r\n    lastActiveTime: string;\r\n    isActive: boolean;\r\n}\r\n\r\ninterface DBData {\r\n    users: DBUser[];\r\n    sessions: DBSession[];\r\n    records: CRMRecord[];\r\n    uploadHistory: UploadHistory[];\r\n    lastModified: string;\r\n}\r\n\r\nconst INITIAL_DATA: DBData = {\r\n    users: [\r\n        {\r\n            id: 'admin-1',\r\n            username: 'admin',\r\n            password: 'admin123', // Default credentials\r\n            name: 'Administrator',\r\n            role: 'admin',\r\n            createdAt: new Date().toISOString(),\r\n        },\r\n        {\r\n            id: 'agent-default',\r\n            username: 'agent',\r\n            password: 'agent', // Default agent credentials\r\n            name: 'Default Agent',\r\n            role: 'agent',\r\n            createdAt: new Date().toISOString(),\r\n        }\r\n    ],\r\n    sessions: [],\r\n    records: [],\r\n    uploadHistory: [],\r\n    lastModified: new Date().toISOString()\r\n};\r\n\r\nfunction ensureDB() {\r\n    // Ensure directory exists\r\n    if (!fs.existsSync(DATA_DIR)) {\r\n        try {\r\n            fs.mkdirSync(DATA_DIR, { recursive: true });\r\n        } catch (e) {\r\n            console.error(\"[DB] Failed to create data directory:\", e);\r\n        }\r\n    }\r\n\r\n    // If DB_FILE doesn't exist in the working directory\r\n    if (!fs.existsSync(DB_FILE)) {\r\n        // Try to copy from seed file (committed data) if it exists and we're using /tmp or a fresh setup\r\n        // Note: checking SEED_FILE !== DB_FILE to avoid copy-to-self if paths overlap\r\n        if (fs.existsSync(SEED_FILE) && path.resolve(SEED_FILE) !== path.resolve(DB_FILE)) {\r\n            try {\r\n                const seedData = fs.readFileSync(SEED_FILE, 'utf-8');\r\n                fs.writeFileSync(DB_FILE, seedData);\r\n                console.log(\"[DB] Seeded database from committed file.\");\r\n                return;\r\n            } catch (error) {\r\n                console.error(\"[DB] Failed to copy seed file:\", error);\r\n            }\r\n        }\r\n\r\n        // Fallback to INITIAL_DATA\r\n        try {\r\n            fs.writeFileSync(DB_FILE, JSON.stringify(INITIAL_DATA));\r\n            console.log(\"[DB] Created new database with initial data.\");\r\n        } catch (e) {\r\n            console.error(\"[DB] Failed to write initial data:\", e);\r\n        }\r\n    }\r\n}\r\n\r\n// Removed persistent memory cache to ensure multi-process consistency (e.g., PM2 cluster)\r\n// Each read will verify the file state.\r\nfunction readDB(): DBData {\r\n    ensureDB();\r\n\r\n    try {\r\n        const data = fs.readFileSync(DB_FILE, 'utf-8');\r\n        const parsed = JSON.parse(data);\r\n        if (!parsed.lastModified) parsed.lastModified = new Date(0).toISOString();\r\n        return parsed;\r\n    } catch (error) {\r\n        console.error(\"[DB] Failed to read database, returning initial data:\", error);\r\n        return JSON.parse(JSON.stringify(INITIAL_DATA));\r\n    }\r\n}\r\n\r\nfunction writeDB(data: DBData) {\r\n    ensureDB();\r\n    try {\r\n        data.lastModified = new Date().toISOString();\r\n        fs.writeFileSync(DB_FILE, JSON.stringify(data));\r\n    } catch (error) {\r\n        console.error(\"[DB] Failed to write database:\", error);\r\n    }\r\n}\r\n\r\nexport const db = {\r\n    getUsers: () => readDB().users,\r\n    addUser: (user: DBUser) => {\r\n        const data = readDB();\r\n        data.users.push(user);\r\n        writeDB(data);\r\n    },\r\n    deleteUser: (userId: string) => {\r\n        const data = readDB();\r\n        data.users = data.users.filter(u => u.id !== userId);\r\n        data.sessions = data.sessions.filter(s => s.userId !== userId);\r\n        writeDB(data);\r\n    },\r\n    findUser: (username: string) => readDB().users.find(u => u.username === username),\r\n    getLastModified: () => readDB().lastModified,\r\n\r\n    getSessions: () => readDB().sessions,\r\n    createSession: (session: DBSession) => {\r\n        const data = readDB();\r\n        // Deactivate previous sessions for this user\r\n        data.sessions.forEach(s => {\r\n            if (s.userId === session.userId && s.isActive) {\r\n                s.isActive = false;\r\n            }\r\n        });\r\n        data.sessions.push(session);\r\n        writeDB(data);\r\n    },\r\n    updateHeartbeat: (userId: string) => {\r\n        // For heartbeat, we can just read, modify, write. \r\n        // Or to save IO, we COULD cache, but strict consistency requires writing.\r\n        // Given heartbeat is every minute, writing is fine for low traffic.\r\n        const data = readDB();\r\n        const session = data.sessions.find(s => s.userId === userId && s.isActive);\r\n        if (session) {\r\n            session.lastActiveTime = new Date().toISOString();\r\n            writeDB(data);\r\n        }\r\n    },\r\n    logoutUser: (userId: string) => {\r\n        const data = readDB();\r\n        const session = data.sessions.find(s => s.userId === userId && s.isActive);\r\n        if (session) {\r\n            session.isActive = false;\r\n            writeDB(data);\r\n        }\r\n    },\r\n\r\n    // Records management\r\n    getRecords: () => readDB().records || [],\r\n    saveRecords: (records: CRMRecord[]) => {\r\n        const data = readDB();\r\n        data.records = records;\r\n        writeDB(data);\r\n    },\r\n    addRecord: (record: CRMRecord) => {\r\n        const data = readDB();\r\n        if (!data.records) data.records = [];\r\n        data.records.push(record);\r\n        writeDB(data);\r\n    },\r\n    updateRecord: (record: CRMRecord) => {\r\n        const data = readDB();\r\n        if (!data.records) data.records = [];\r\n        data.records = data.records.map(r => r.id === record.id ? record : r);\r\n        writeDB(data);\r\n    },\r\n    deleteRecord: (id: string) => {\r\n        const data = readDB();\r\n        if (!data.records) data.records = [];\r\n        data.records = data.records.filter(r => r.id !== id);\r\n        writeDB(data);\r\n    },\r\n    deleteRecords: (ids: string[]) => {\r\n        const data = readDB();\r\n        if (!data.records) data.records = [];\r\n        data.records = data.records.filter(r => !ids.includes(r.id));\r\n        writeDB(data);\r\n    },\r\n\r\n    // Upload History\r\n    getUploadHistory: () => readDB().uploadHistory || [],\r\n    addUploadHistory: (history: UploadHistory) => {\r\n        const data = readDB();\r\n        if (!data.uploadHistory) data.uploadHistory = [];\r\n        data.uploadHistory.unshift(history);\r\n        writeDB(data);\r\n    },\r\n    // Get active sessions populated with user details\r\n    getActiveAgents: () => {\r\n        const data = readDB();\r\n        return data.users.map(user => {\r\n            const activeSession = data.sessions.find(s => s.userId === user.id && s.isActive);\r\n            return {\r\n                ...user,\r\n                // Don't return password\r\n                password: '***',\r\n                isLoggedIn: !!activeSession,\r\n                punchInTime: activeSession?.punchInTime || null,\r\n                lastActiveTime: activeSession?.lastActiveTime || null,\r\n            };\r\n        });\r\n    }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 261, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Hardik/Downloads/crm/app/api/records/route.ts"],"sourcesContent":["\r\nimport { NextResponse } from 'next/server';\r\nimport { db } from '@/lib/db';\r\nimport { CRMRecord } from '@/lib/types';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport async function GET() {\r\n    try {\r\n        const records = db.getRecords();\r\n        return NextResponse.json({ records });\r\n    } catch (error) {\r\n        return NextResponse.json({ error: 'Failed to fetch records' }, { status: 500 });\r\n    }\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n    try {\r\n        const body = await req.json();\r\n        const records = body.records; // Expecting array of records\r\n\r\n        if (Array.isArray(records)) {\r\n            // Appending multiple records\r\n            const currentRecords = db.getRecords();\r\n            db.saveRecords([...currentRecords, ...records]);\r\n            return NextResponse.json({ success: true, count: records.length });\r\n        } else {\r\n            // Single record\r\n            db.addRecord(body);\r\n            return NextResponse.json({ success: true });\r\n        }\r\n    } catch (error) {\r\n        console.error(\"POST /api/records error:\", error);\r\n        return NextResponse.json({ error: 'Failed to save records' }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AACA;AACA;;;AAGO,MAAM,UAAU;AAEhB,eAAe;IAClB,IAAI;QACA,MAAM,UAAU,iHAAE,CAAC,UAAU;QAC7B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE;QAAQ;IACvC,EAAE,OAAO,OAAO;QACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA0B,GAAG;YAAE,QAAQ;QAAI;IACjF;AACJ;AAEO,eAAe,KAAK,GAAY;IACnC,IAAI;QACA,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,UAAU,KAAK,OAAO,EAAE,6BAA6B;QAE3D,IAAI,MAAM,OAAO,CAAC,UAAU;YACxB,6BAA6B;YAC7B,MAAM,iBAAiB,iHAAE,CAAC,UAAU;YACpC,iHAAE,CAAC,WAAW,CAAC;mBAAI;mBAAmB;aAAQ;YAC9C,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAM,OAAO,QAAQ,MAAM;YAAC;QACpE,OAAO;YACH,gBAAgB;YAChB,iHAAE,CAAC,SAAS,CAAC;YACb,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;YAAK;QAC7C;IACJ,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAyB,GAAG;YAAE,QAAQ;QAAI;IAChF;AACJ"}}]
}